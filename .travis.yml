os: linux
dist: bionic
language: python
python: 3.8
sudo: true
services:
- docker
env:
  global:
  - secure: JEeNF1tMdjKgcddNRzUCsfINA2meTFLQ5ltqEg40/rWkv3V6s2qgYAtLoC5SoKulb8xMDgIQiVHpQiHNeAjATiX9qYEHl9FEmrFkv03mDFJIlPDtgZ5RQwoBnWrNqlX62nvWaO3/qfISovwIbnIp15k1ULvUN1oPr5Egr+CNmzTktXOXCZchKW55GjJAeSM4EgVLH/5LM2bisEEAlVCz+catmvZDkkiHmy1mq1FM9/DwgonkATPHIOs4Enkicc20nVtx2iRrNKFkMzQbzplrLkJCjZcYVjvIN0mB8cOIGHS6dOy7aApQbZ1tQzLCehy+5rLNKw8PZnNzLrBocQ0lV/NzzKI7vwYfaYUmRzEh3kO7WZV6oUllaRy6+Y+edPd7GCstBkwp8W/Xi9CHdQavDahqtR/S21KvatbGnLWl1LKVI4FePYB4YelKqzB0tKxOS40xdpIKydbH01K2kqbZlqWicAyN4bk4N4NumnoCJix5Ep3Me0wYJkiOEiNMsSz+7kEbKoiG7hKmLsD8ZgAVPXgpFIZ25GwQqmJG60P7Ao4DWFtIfOoSMBtNgx+em7f3BRPzM9gJ0hQFfAAhwnsk+VEDq8B6B1sRKh8dk8/UDKE+gDCPBLr/q/p+9Q9xg3G3MxbTdc15+pj5mPO7jHBcQeMLzPyLUhYIupFZatMbppE=
  - secure: dq0QNLLD8yOKGQw+jDdIeEAJuQGuS8mjuqLVCuKypUKiazD0HZAxGU1cdU6uNCjM/+DCIJ5mNquNsb9d/KvAANol4mQdSigTEQTmrQcU/tb3pDdjnVAma/ZuTGRaiHrcgT5qRBtw1muIH1Y/iAf4I5+IYqYMpMDdelHhqxHiqE9KFaqNVgk+fbExeDmPO6qBElVpSw3waUWLLV6I+GCv5/btcrATjr52fwO6LafA1Uf3rHPeK+idlcrlt+LvbirFWwEHJdSrGYK2SWYK8igP4RJm33QYaeYXONROhDaubt2VtserzbCb3DHsyK/HB4KOqa0m/GXMbqIHHEgNvLmjdROlEWJKigtuICjw0y1rq+b4rc1eXnNkgmDWto4gIZMlKT2TDrfAWruphnALpJLILQYtgUtiqAIV2lfrc+tO53/ZyJptvBWcGXgEvgMKQO4N6p0eQFR/JJJO1oqlg600leHOJiK/K12SYQWNFSyVsVRISTOdYw3SIwq/L16A0axOWTBvRuVU8wF2V9j3GFJfkBGJAmyQNCOQWH/LlNfYN2EfQesKsYAIxpmGhee1vwJGA8IOwFNVB0cCV2ZdzDToKRyYfHATp8QtJl7Cs6qAYtDYRg25T/UKomdiFoekx1IyrgTk1GXREpDw/KqRr0oCKdz//U3x4Fj9cSpzyL/kXCw=
jobs:
  include:
    # TODO: Only perform this step if the file deps.Dockerfile changed.
    # https://docs.travis-ci.com/user/conditional-builds-stages-jobs/#conditional-stages
    # https://stackoverflow.com/a/38550849/2769475
    # https://docs.travis-ci.com/user/environment-variables/#default-environment-variables
    #- stage: build deps image
    #  script:
    #  - docker build --no-cache -t scale-mamba-deps -f deps.Dockerfile .
    #  - echo "$DOCKER_USERNAME"
    #  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    #  - docker tag scale-mamba-deps $DOCKER_USERNAME/scale-mamba-deps
    #  - docker push $DOCKER_USERNAME/scale-mamba-deps
    - stage: build image
      script:
      - docker build --no-cache -t scale-mamba -f py2.Dockerfile .
      - echo "$DOCKER_USERNAME"
      - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
      - docker tag scale-mamba $DOCKER_USERNAME/scale-mamba
      - docker push $DOCKER_USERNAME/scale-mamba
    - stage: test
      name: test set 1
      env: TEST_SET=1
      script:
      - ./before_test.sh
      # TODO: re-use an image that has make test already done
      - docker run --rm $DOCKER_USERNAME/scale-mamba make test
      - docker run --rm $DOCKER_USERNAME/scale-mamba sh .ci/run_tests.sh
    - stage: doc
      script: docker run --rm $DOCKER_USERNAME/scale-mamba make doc
